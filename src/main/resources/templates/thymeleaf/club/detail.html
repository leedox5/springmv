<html layout:decorate="~{thymeleaf/club/layout}">
<div layout:fragment="content" class="container my-3">
    <div class="text-end">
		<form th:action="@{/club/meeting}" method="get">
			<button  type="submit" class="btn btn-sm btn-outline-primary">목록으로</button>
		</form>
    </div>
    <div class="row border-bottom">
        <div class="col-8">
            <h2 th:text="${game.subject}"></h2>
        </div>
        <div class="col-4 text-end">
            <div class="btn-toolbar justify-content-end mt-2 mb-2">
                <div class="btn-group btn-group-sm">
                    <a th:href="|@{/club/meeting/modify/}${game.id}|" class="btn btn-outline-secondary">수정</a>
                    <a href="#" class="delete btn btn-outline-secondary" th:attr="data-uri='/club/meeting/delete/' + ${game.id}">삭제</a>
                </div>
            </div>
        </div>
    </div>


    <table class="table">
        <thead class="text-center table-dark">
            <tr>
                <td>NO</td>
                <td>Name</td>
                <td>G1</td>
                <td>G2</td>
                <td>G3</td>
                <td>G4</td>
                <td>삭제</td>
            </tr>
        </thead>
        <tbody>
            <tr th:each="player : ${game.getPlayers()}"class="text-center">
                <td th:text="${player.seq}"></td>
                <td th:text="${player.name}"></td>
                <td th:text="${player.score01} ? |${player.score01}@{:}${player.score11}| : ''"></td>
                <td th:text="${player.score02} ? |${player.score02}@{:}${player.score12}| : ''"></td>
                <td th:text="${player.score03} ? |${player.score03}@{:}${player.score13}| : ''"></td>
                <td th:text="${player.score04} ? |${player.score04}@{:}${player.score14}| : ''"></td>
                <td>
                    <th:block th:if="${game.getMatches().isEmpty()}">
                    <a href="#" class="delete btn btn-sm btn-outline-secondary" th:attr="data-uri='/club/player/delete/' + ${player.id}">삭제</a>
                    </th:block>
                </td>
            </c:forEach>
        </tbody>
    </table>
    <form id="form1" th:action="|@{/club/player/create/}${game.id}|" method="post">
        <div class="input-group input-group-sm mb-3">
            <span class="input-group-text">Name</span>
            <input type="text" class="form-control" name="name" id="name" value="">
            <button type="submit" class="btn btn-outline-secondary">Add</button>
        </div>
        <div id="err"></div>
    </form>
    <div class="btn-toolbar justify-content-end">
        <c:when test="${empty game.getMatches()}">
            <div th:if="${game.getMatches().isEmpty()}" class="btn-group btn-group-sm">
                <a th:href="|@{/club/match/create/}${game.id}|" class="btn btn-outline-secondary">대진표 생성</a>
            </div>
            <div th:unless="${game.getMatches().isEmpty()}" class="btn-group btn-group-sm">
                <a th:href="|@{/club/match/delete/}${game.id}|" class="btn btn-outline-secondary">대진표 삭제</a>
            </div>
    </div>
    <h5 class="border-bottom py-2">대진표</h5>
    <table class="table">
        <thead class="text-center table-dark">
            <tr>
                <td>Team A : Team B</td>
                <td>결과</td>
            </tr>
        </thead>
        <tbody>
            <th:block th:each="match : ${game.getMatches()}">
            <tr class="text-center">
                <td th:text="|@{[}${match.seq}@{]}${match.description}|"></td>
                <td>
                    <th:block th:if="${not #strings.isEmpty(match.score1)}" th:text="|${match.score1}@{:}${match.score2}|">
                    </th:block>
                    <th:block th:unless="${not #strings.isEmpty(match.score1)}">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" th:attr="data-bs-target='#collap' + ${match.id}">입력</button>
                    </th:block>
                </td>
            </tr>

            <tr>
                <td colspan="3">
                    <div th:id="'collap' + ${match.id}" class="collapse">
                        <form th:action="|@{/club/match/save/}${match.id}|" method="post">
                            <div class="input-group input-group-sm justify-content-end">
                                <span class="input-group-text">Score</span>
                                <select class="form-select" name="score1" id="score1">
                                    <option value="6" selected>6</option>
                                    <option value="5">5</option>
                                    <option value="4">4</option>
                                    <option value="3">3</option>
                                    <option value="2">2</option>
                                    <option value="1">1</option>
                                    <option value="0">0</option>
                                </select>
                                <span class="input-group-text">:</span>
                                <select class="form-select" name="score2" id="score2">
                                    <option value="6" selected>6</option>
                                    <option value="5">5</option>
                                    <option value="4">4</option>
                                    <option value="3">3</option>
                                    <option value="2">2</option>
                                    <option value="1">1</option>
                                    <option value="0">0</option>
                                </select>
                                <button type="submit" class="btn btn-outline-secondary">결과입력</button>
                            </div>
                        </form>
                    </div>
                </td>
            </tr>
            </th:block>
        </tbody>
    </table>

    <!-- 집계-->
    <h5 class="border-bottom py-2">집계</h5>
    <div class="text-end mb-2">
        <a th:href="@{|/club/player/ranking/${game.id}|}" class="btn btn-sm btn-outline-secondary">집계</a>
    </div>
    <table class="table">
        <thead class="text-center table-dark">
            <tr>
                <td>Name</td>
                <td>MW</td>
                <td>ML</td>
                <td>GW</td>
                <td>GL</td>
                <td>SM</td>
                <td>RA</td>
            </tr>
        </thead>
        <tbody>
            <th:block th:each="player : ${game.getPlayers()}">
            <tr class="text-center">
                <td th:text="${player.name}">     </td>
                <td th:text="${player.matchWin}"> </td>
                <td th:text="${player.matchLose}"></td>
                <td th:text="${player.gameWin}">  </td>
                <td th:text="${player.gameLose}"> </td>
                <td th:text="${player.gameSum}">  </td>
                <td th:text="${player.matchRank}"></td>
            </tr>
            </th:block>
        </tbody>
    </table>
</div>
<script layout:fragment="script">
const cnt_match = [[${game.getMatches().size()}]] ;
$(document).ready(function() {
    console.log("ready");
    //$.getParam();
    $("#form1").submit(function(event) {
        event.preventDefault();
        if(cnt_match > 0) {
            alert("대진표가 이미 생성되었습니다.");
            return;
        }
        $.ajax_submit();
    });
});

const delete_elements = document.getElementsByClassName("delete");
Array.from(delete_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("정말로 삭제하시겠습니까?")) {
		    var form_data = {};
			var loc = this.dataset.uri;
            $.ajax({
                type: "GET",
                contentType: "application/json",
                url: loc,
                data: null,
                dataType: "json",
                success: function(data) {
                    var json = JSON.stringify(data, null, 4);
                    if(data.errorContent == "Y") {
						if(loc.indexOf("player") > -1) {
                            location.reload();
						} else {
                            location.href = "/club/meeting";
						}
                    } else {
                        //$("#err").html(data.messages[0]);
					    alert(data.messages[0]);
                    }
                },
                error: function(e) {
				    alert(e.responseText);
                    console.log(e);
                }
            });
        }
    });
});

$.ajax_submit = function() {
	var form_data = {};
	form_data.name = $("#name").val();

	$.ajax({
		type: "POST",
		contentType: "application/json",
		url: "/club/player/create1/" + [[${game.id}]],
		data: JSON.stringify(form_data),
		dataType: "json",
		success: function(data) {
			var json = JSON.stringify(data, null, 4);
			if(data.errorContent == "Y") {
				location.reload();
			} else {
				$("#err").html(data.messages[0]);
			}
		},
		error: function(e) {
			$("#err").html(e.responseText);
			console.log(e);
		}
	});
}

</script>