<!DOCTYPE html>
<html lagn="ko">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <!-- sbb CSS -->
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    <title>단어장</title>
</head>
<body>
<!-- 네비게이션바 -->
<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom" id="navbar_id">
    <div class="container-fluid">
        <a class="navbar-brand" href="/words.html">단어장</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="hamburger_menu_button">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
			    <li class="nav-item">
                    <a id="link3" class="nav-link" href="#">소개</a>
				</li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                       단어장 목록
                    </a>
                    <ul class="dropdown-menu">
                        <li><a id="link1" class="dropdown-item" href="#">내단어장</a></li>
                        <li><a id="link2" class="dropdown-item" href="#">오픈단어장</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#">기타</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">로그아웃</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div id="top" class="container my-2">
    <div class="mt-1 mb-1">
        <span id="username"></span>님 반갑습니다.
    </div>
    <h5 id="tit" class="my-3 border-bottom pb-2">내단어장</h5>
    <div id="search" class="input-group input-group-sm mb-2">
        <div class="input-group-prepend">
            <select class="form-select" name="opt" id="opt"></select>
        </div>
        <span class="input-group-text">Key</span>
        <input type="text" class="form-control" name="key" id="key">
        <button id="btn1" type="submit" class="btn btn-outline-secondary">검색</button>
    </div>
</div>
<!-- 기본 템플릿 안에 삽입될 내용 Start -->
<div id="main" class="container my-2">
    <div class="row ">
        <div class="col-8">
            <h6 id="cnt1" class="small text-muted text-start mt-1"></h6>
        </div>
        <div class="col-4 text-end">
            <button id="btn_add" class="btn btn-sm btn-secondary">단어 추가</button>
        </div>
    </div>
    <table id="grid1" class="table mt-1">
        <thead class="text-left table-dark">
        <tr>
            <th>단어</th>
            <th>의미</th>
        </tr>
        </thead>
        <tbody>
        
        </tbody>
    </table>
</div>

<!-- 기본 템플릿 안에 삽입될 내용 End -->
<!-- Bootstrap JS -->
<script src="/js/jquery-3.6.0.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<!-- 자바스크립트 Start -->

<script src="/js/wordbook/list.js"></script>
<script>

// 검색조건 설정
const setOpts = (opts, sel) => {
    $("#opt").empty();
    
    $.each(opts, function(index, item) {
        const opt = `<option value='${item.val}'>${item.txt}</option>`;
        $("#opt").append(opt);
    });
    $("#opt").val(sel);
}

//Grid에 데이터 채우기
const setGrid = (rows) => {
    var rowtag = "";
    
    $("#grid1>tbody").empty();
        
    $.each(rows, function(index, item) {
        row_tag  = `<tr>`;
        if(path) {
            //row_tag += `<td class="text-start"><a href="/wordbook/word/${item.id}/${path}">${item.word}</a></td>`;
            row_tag += `<td class="text-start"><a href="javascript:void(0);" onClick="return detail('${item.id}')">${item.word}</a></td>`;
        } else {
            //row_tag += `<td class="text-start"><a href="/wordbook/word/${item.id}">${item.word}</a></td>`;
            row_tag += `<td class="text-start"><a href="javascript:void(0);" onClick="return detail('${item.id}');">${item.word}</a></td>`;
            //button 으로 처리하기
            //row_tag += `<td class="text-start"><button type="button" class="btn btn-link" onClick="detail('${item.id}')">${item.word}</button></td>`;
        }
        row_tag += `<td class="text-start">${item.meaning1}</td>`;
        row_tag += `</tr>`;
    
        $("#grid1>tbody").append(row_tag);
    });
    
    $("#cnt1").text(rows.length);
}

// 데이터를 가져온후 
const afterGetData = (res) => {
    if(res.status == 200) {
        data = res.data;
        console.log(data);
        $("#username").text(data.username);
        setOpts(data.opts, data.selOpt);
        setGrid(data.words);
    } else {
        console.log(res);
        if(res.message == "LOGIN") {
            window.location.href = "/login";
        } else {
            alert(res.message);
        }
    }
}

const detail = (id) => {
    console.log("WORD ID:" + id);

    $("#main").load("/wordbook/word/" + id);

    if(typeof $.chkDetail === "undefined") {
        $.getScript("/js/wordbook/detail.js", function() {
            $.chkDetail(id);
        });
    } else {
        $.chkDetail(id);
    }
}



// Search
/* ---
const btn1 = document.getElementById("btn1");

if (btn1) {
    btn1.addEventListener('click', () => {
        var opt = $("#opt").val();
        var key = $("#key").val();
      
        var loc = `/data/search/${opt}`;
        
        path = opt;
        
        if (key) {
            loc += `/${key}`;
            path += `/${key}`;
        }
        
        console.log(loc);
        $.getData(loc, afterGetData);
    });
}
--- */
// 동적으로 생성된 element 에 이벤트 걸기
$(document).on("click", "#btn1", function() {
    var opt = $("#opt").val();
    var key = $("#key").val();

    if(search_type == "MY") {
        var loc = `/data/search/${opt}`;
    } else {
        var loc = `/data/search1/${opt}`;
    }

    path = opt;

    if (key) {
        loc += `/${key}`;
        path += `/${key}`;
    }

    console.log(loc);
    $.getData(loc, afterGetData);
});

// 추가
$(document).on("click", "#btn_add", function() {
    $("#search").hide();
    $("#main").load("/wordbook/add");
    if(typeof $.chkCreate === "undefined") {
        $.getScript("/js/wordbook/create.js", function() {
            console.log("create.js was loaded!");
            $.chkCreate();
        });
    }
});

// 소개
const link3 = document.getElementById("link3");

if (link3) {
    link3.addEventListener('click', () => {
        $("#main").load("/wordbook/intro");
    });
}

// 내단어장
const link1 = document.getElementById("link1");

if (link1) {
    link1.addEventListener('click', () => {
        var loc = `/data/search`;
        $("#tit").text("내단어장");
        search_type = "MY";

        $("#main").load("/cont1.html", function(responseTxt, statusTxt, xhr) {
            if(statusTxt == "success") {
                $.getData(loc, afterGetData);
            }
        });
    });
}

// 오픈단어장
const link2 = document.getElementById("link2");

if (link2) {
    link2.addEventListener('click', () => {
        var loc = `/data/search1`;

        $("#tit").text("오픈단어장");
        search_type = "OPEN";

        $.getData(loc, afterGetData);
        $("#main").load("/cont1.html", function(responseTxt, statusTxt, xhr) {
            if(statusTxt == "success") {
                $.getData(loc, afterGetData);
            }
        });
    });
}

var data = {};
var opt = "";
var key = "";
var path = "";

var search_type = "MY";

/* --- sample data
data.username = '홍길동';
data.opts = [
    { val : "eng", txt : "단어"}
   ,{ val : "kor", txt : "의미"}
   ,{ val : "tag", txt : "태그"}
];
data.selOpt = "tag";

data.words = [
    { word : "appoint", meaning1 : "임명하다"}
   ,{ word : "author" , meaning1 : "작가"    }
];
--- */

$(function() {

    if(key) {
        $("#key").val(key);
    }

    if(path) {
        $.getData("/data/search/" + path, afterGetData);
    } else {
        $.getData("/data/words", afterGetData);
    }

	window.onload = function () {
		document.addEventListener("click", function (event) {
			// if the clicked element isn't child of the navbar, you must close it if is open
			if (!event.target.closest("#navbar_id") && 
			        document.getElementById("navbarSupportedContent").classList.contains("show")) {
				document.getElementById("hamburger_menu_button").click();
			}
		});
	}
});



</script>

<!-- 자바스크립트 End -->
</body>
</html>